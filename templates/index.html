<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>ListShopCupom Dashboard</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <h1>ListShopCupom Dashboard</h1>

  <section>
    <h2>Keywords ({{ total_keywords }})</h2>
    <ul id="keywords-list">
      {% for key, value in keywords.items() %}
        <li>{{ key }} - regex: {{ value.regex }}</li>
      {% endfor %}
    </ul>

    <h3>Adicionar Keyword</h3>
    <form id="add-keyword-form">
      <input name="name" placeholder="Keyword" required>
      <input name="regex" placeholder="Regex (opcional)">
      <button type="submit">Adicionar</button>
    </form>
  </section>

  <hr>

  <section>
    <h2>Ignore List ({{ total_ignores }})</h2>
    <ul id="ignore-list">
      {% for item in ignores %}
        <li>{{ item }} <button type="button" onclick="removeIgnore('{{ item }}')">Remover</button></li>
      {% endfor %}
    </ul>

    <h3>Adicionar Ignore</h3>
    <form id="add-ignore-form">
      <input name="item" placeholder="Ignore item" required>
      <button type="submit">Adicionar</button>
    </form>
  </section>

  <script>
    async function reloadKeywords() {
      const res = await fetch("/keywords");
      const data = await res.json();
      const ul = document.getElementById("keywords-list");
      ul.innerHTML = "";
      for (const [key, val] of Object.entries(data)) {
        const li = document.createElement("li");
        li.textContent = `${key} - regex: ${val.regex}`;
        ul.appendChild(li);
      }
    }

    async function reloadIgnores() {
      const res = await fetch("/ignore");
      const data = await res.json();
      const ul = document.getElementById("ignore-list");
      ul.innerHTML = "";
      data.forEach(i => {
        const li = document.createElement("li");
        li.innerHTML = `${i} <button type="button" onclick="removeIgnore('${i}')">Remover</button>`;
        ul.appendChild(li);
      });
    }

    document.getElementById("add-ignore-form").onsubmit = async function(e){
      e.preventDefault();
      const item = this.item.value.trim();
      if (!item) return;

      const res = await fetch("/ignore/add", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
        body: new URLSearchParams({ raw: `"${item}"` })
      });

      if (res.ok) {
        await reloadIgnores();
        this.reset();
      } else {
        console.error("Erro ao adicionar ignore", await res.text());
      }
    };

    async function removeIgnore(item){
      const res = await fetch("/ignore/remove", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
        body: new URLSearchParams({ termo: item })
      });

      if (res.ok) {
        await reloadIgnores();
      } else {
        console.error("Erro ao remover ignore", await res.text());
      }
    }

    document.getElementById("add-keyword-form").onsubmit = async function(e){
      e.preventDefault();
      const name = this.name.value.trim();
      const regex = this.regex.value.trim();
      if (!name) return;

      const raw = `"${name}"` + (regex ? ` "${regex}"` : "");
      const res = await fetch("/keywords/add", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
        body: new URLSearchParams({ raw })
      });

      if (res.ok) {
        await reloadKeywords();
        this.reset();
      } else {
        console.error("Erro ao adicionar keyword", await res.text());
      }
    };
  </script>
</body>
</html>
